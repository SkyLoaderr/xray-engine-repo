    
local animations = {
                   "idle_0_idle_0",
                   "idle_0_idle_1",
                   "idle_0_idle_2",
                   "idle_0_idle_3",
                   "idle_0_idle_4",
                   "idle_1_idle_0",
                   "idle_1_idle_1",
                   "idle_1_idle_2",
                   "idle_1_idle_3",
                   "idle_1_idle_4"
                   }
                   

----------------------------------------------------------------------------
class "evaluator_complete" (property_evaluator)
-------------------
function evaluator_complete:__init (storage, name) super ()
    self.a = storage
end
-------------------
function evaluator_complete:evaluate ()
    return not (self.a.enabled == true)
end
-------------------


----------------------------------------------------------------------------
class "action_bar" (action_base)
-------------------
function action_bar:__init (name, storage) super (nil, name)
    self.current_animation = math.random (1, table.getn (animations))
    self.interlocutor = nil
    self.talk_enabled = false
    self.a = storage
    self.theme = nil
    self.sub_theme = 0
    self.phrase = 0
    self.wait_time = 0
    self.wait = 0
    self.delay = 0
end
-------------------
function action_bar:initialize ()
    action_base.initialize (self)
    self.object:clear_animations ()
    self.object:set_node_evaluator        ()
    self.object:set_path_evaluator        ()
    self.object:set_desired_position      ()
    self.object:set_body_state            (move.standing)
    self.object:set_movement_type         (move.stand)
    self.object:set_mental_state          (anim.free)
    self.current_animation = math.random  (1, table.getn (animations))
    self.talk_enabled = false
    
    if self.a.interlocutor == nil then
       self.theme = "bar_talk_single"
    else
       self.theme = "bar_talk_double"
    end       
    
    self.delay = device ():time_global () + math.random (1000, 60000)
end    
-------------------
function action_bar:execute ()
    action_base.execute (self)
    
    if self.interlocutor == nil and self.a.interlocutor ~= nil then
       self.interlocutor = level.object (self.a.interlocutor)
       if self.interlocutor ~= nil then
          xr_motivator.storage[self.interlocutor:id ()].bar_stalker.passive = true
       end   
       self.talk_enabled = true
    end   
    
    if self.object:animation_count () < 2 then
       self:set_animation ()
    end
    
    if self.a.interlocutor == nil then
       self:single_talk ()
    else
       if self.talk_enabled == true then
          self:double_talk ()
       end   
    end            
        
end    
-------------------
function action_bar:finalize ()
    action_base.finalize (self)
    self.object:clear_animations ()
end    
-------------------
function action_bar:single_talk ()
    if self.a.passive == true then return end
    if self.sub_theme == 0 then
       if self.delay - device ():time_global ()  > 0 then return end 
       self.sub_theme = xr_sounds.get_random_subtheme (self.theme) 
       self.phrase = 1
       self.delay = 0
       return
    end
    
    if self.object:active_sound_count () ~= 0 then 
       return
    else
       if self.delay ~= 0 and self.delay - device ():time_global () > 0 then return end
    end   
    
    xr_sounds.play_sound (self.object, 0, self.theme, self.sub_theme, self.phrase)
    self.delay = device ():time_global () + math.random (20000, 50000)
    self.phrase = self.phrase + 1
    if self.phrase > xr_sounds.get_num_phrases (self.theme, self.sub_theme) then
       self.sub_theme = 0
    end   
           
end
-------------------
function action_bar:double_talk ()
    if self.interlocutor == nil then return end
    
    if self.sub_theme == 0 then
       if self.delay - device ():time_global () > 0 then return end
       self.sub_theme = xr_sounds.get_random_subtheme (self.theme) 
       self.phrase = 1
       self.delay = 0
       return
    end
    
    if self.interlocutor:active_sound_count () ~= 0 or self.object:active_sound_count () ~= 0 then
       return
    else
       if self.delay ~= 0 and self.delay - device ():time_global () > 0 then return end
    end   
                
    local talker = nil
    if bit_and (self.phrase, 1) == 1 then
       talker = self.object
    else    
       talker = self.interlocutor
    end    
    
    
    xr_sounds.play_sound (talker, 0, self.theme, self.sub_theme, self.phrase)
    self.delay = device ():time_global () + math.random (1500, 3000)
    self.phrase = self.phrase + 1
    if self.phrase > xr_sounds.get_num_phrases (self.theme, self.sub_theme) then
       self.sub_theme = 0
       self.delay = device ():time_global () + math.random (30000, 50000)
    end   
    
end
-------------------
function action_bar:set_animation ()

    self.current_animation = self.current_animation + 1
    if self.current_animation > table.getn (animations) then
       self.current_animation = 1
    end

    self.object:add_animation (animations[self.current_animation], false)
end



----------------------------------------------------------------------------
function add_to_binder (npc, ini)
    if true then return end
    
   	if ini == nil or ini:section_exist ("bar") == false or ini:line_exist ("bar", "enabled") == false then 
   	   return 
    end
    
    local st = xr_motivator.storage[npc:id()].bar
    st.enabled = ini:r_bool ("bar", "enabled")
    if st.enabled == false then return end
    if ini:line_exist ("bar", "meat") == true then 
       st.meat = ini:r_bool ("bar", "meat")
    end
    
    if ini:line_exist ("bar", "interlocutor") == true then
       st.interlocutor = ini:r_string ("bar", "interlocutor")     
    end
    
    if ini:line_exist ("bar", "talk_enable") == true then
       st.talking = ini:r_bool ("bar", "talk_enable")
    end
    
    local satiety = ini:r_u32 ("rest", "satiety_threshold") / 100.0
    
    local manager = npc:motivation_action_manager ()
    local property = {}
    local operators = {}
    
    property["complete"] = xr_evaluators_id.sidor_bar
    operators["bar"] = xr_actions_id.sidor_act_bar
    
    manager:add_evaluator (property["complete"], this.evaluator_complete (xr_motivator.storage[npc:id()].bar, "property_complete"))
    
    local action = this.action_bar ("action_bar", xr_motivator.storage[npc:id()].bar)
    action:add_precondition         (world_property (stalker_ids.property_alive,    true))
    action:add_precondition         (world_property (stalker_ids.property_enemy,    false))
    action:add_precondition         (world_property (property["complete"],        false))
    action:add_effect               (world_property (property["complete"],        true))
    manager:add_action              (operators["bar"], action)
               
    action = manager:action (stalker_ids.action_puzzle_solver)
    action:add_precondition (world_property (property["complete"],  true))
    
end
----------------------------------------------------------------------------