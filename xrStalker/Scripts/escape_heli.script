--[[------------------------------------------------------------------------------------------------------------------
Управление вертолётом для Escape. Патрулирование, убийство новичков возле вагончика.
Чугай Саша
--------------------------------------------------------------------------------------------------------------------]]

local heli_mgr
local actor

local state_before      = 0
local state_heli_attack = 1
local state_after       = 2

local state_init

-- нужно сохранять
local state
local wounded_id
local newbies = {}
local attack_end

function cb( zone, obj )
	if obj:id() == actor:id() then
		actor:give_info_portion( "tutorial_artefact_gain" )
	end
end

function on_enter( zone, obj )
--	printf( "ZONE CALLBACK" )
	-- если раненный родился, то запомнить его ID и тут же спрятать
	if obj:name() == "esc_vagon_wounded" then
		wounded_id = obj:id()

		obj:set_start_dialog( "escape_vagon_wounded" )

		local sim = alife()
		sim:set_switch_online(  wounded_id, false )
		sim:set_switch_offline( wounded_id, true )
		
		zone:clear_callback( true )
	end
end

function chst( new_state )
	state      = new_state
	state_init = true
end

function update()
	-- вертолёт летает неподалёку
	if state == state_before then
		if state_init then
			heli_mgr:set_path( "heli_path_tutorial" )
			heli_mgr.not_die = true

			get_level_object( "esc_vagon_wounded_spawn_zone" ):set_callback( on_enter, true )
--			printf( "CALLBACK SET" )

			state_init = false
		end

		if actor:has_info( "tutorial_artefact_gain" ) then
			chst( state_heli_attack )
		end
	end

	-- перестрелка с вертолётом
	if state == state_heli_attack then
		if state_init then
			for i = 1, 2 do
				table.insert( newbies, get_level_object( "esc_vagon_newbie" .. i ) )
			end

			attack_end = game.CTime()
			attack_end:setHMS( 0, 10, 0 )
			attack_end:add( game.get_game_time() )

			state_init = false
		end

		-- вертолёт атакует новичков
		if not heli_mgr.enemy then
			heli_mgr:set_enemy( newbies[1], 1000 )
		else
			if not heli_mgr.enemy:alive() then
				table.remove( newbies, 1 )
				heli_mgr:set_enemy( newbies[1], 1000 )
			end
		end

		-- если все умерли
		if table.getn( newbies ) == 0 then
			chst( state_after )
		end

		-- если прошло время
		if attack_end < game.get_game_time() then
			-- убить всех живых
			for i, npc in newbies do
				npc:kill( heli_mgr.heli )
			end

			chst( state_after )
		end
	end

	-- сцена закончена
	if state == state_after then
		if state_init then
			-- рождаем раненного
			local sim = alife()
			sim:set_switch_online( wounded_id, true )

			-- отправить вертолёт патрулировать уровень
			heli_mgr:set_path( "heli_path_patrol" )
			heli_mgr.not_die = false

			state_init = false
		end
	end
end

function main()
	actor = get_actor()

	heli_mgr = xr_heli.HeliManager()
	heli_mgr:initialize( "heli" )

--	get_level_object( "z" ):set_callback( cb, true )

	if not state then
		chst( state_before )
	end

	while true do
		update()
		heli_mgr:update()
		wait()
	end
end
